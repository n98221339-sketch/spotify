<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Premium - Pro Edition (Fixed)</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/w9B1mZG/Spotify-Icon-Logo-wine.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- CSS GỐC + BỔ SUNG TÍNH NĂNG SCROLL --- */
        :root {
            --bg-base: #000000;
            --bg-surface: #121212;
            --bg-card: #181818;
            --sp-purple: #a855f7;
            --sp-light: #c084fc;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-main);
            font-family: 'Circular Sp', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* QUAN TRỌNG: Cho phép cuộn trang */
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* --- UI TOAST (THAY THẾ ALERT) --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999999;
        }

        .toast {
            background: #282828;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--sp-purple);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* --- LAYOUT CHÍNH (GIỮ NGUYÊN) --- */
        .wrapper {
            display: flex;
            flex: 1;
            padding: 8px;
            gap: 8px;
            margin-bottom: 90px;
        }

        .sidebar {
            width: 72px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: sticky;
            top: 8px;
            height: calc(100vh - 110px);
        }

        .side-box {
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .side-icon {
            font-size: 24px;
            color: var(--text-sub);
            cursor: pointer;
            transition: 0.2s;
        }

        .side-icon:hover,
        .side-icon.active {
            color: #fff;
            transform: scale(1.1);
        }

        .main-content {
            flex: 1;
            background: var(--bg-surface);
            border-radius: 8px;
            position: relative;
            min-height: 100%;
            padding-bottom: 20px;
        }

        .top-bar {
            position: sticky;
            top: 0;
            height: 64px;
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 100;
            border-radius: 8px 8px 0 0;
        }

        .profile-zone {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 20px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.7);
            transition: 0.2s;
        }

        .profile-zone:hover {
            background: #282828;
        }

        .profile-img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 13px;
            font-weight: bold;
        }

        /* --- GRID & CARD (CÓ THÊM NÚT SỬA/XÓA) --- */
        .home-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            padding: 20px;
        }

        .card {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 8px;
            transition: 0.3s;
            cursor: pointer;
            position: relative;
        }

        .card:hover {
            background: #282828;
            transform: translateY(-5px);
        }

        .card img {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 6px;
            object-fit: cover;
            margin-bottom: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        /* Nút ẩn hiện trên Card */
        .card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: 0.2s;
        }

        .card:hover .card-actions {
            opacity: 1;
        }

        .btn-mini {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .btn-mini:hover {
            background: var(--sp-purple);
            transform: scale(1.1);
        }

        .btn-mini.del:hover {
            background: #ff4d4d;
        }

        /* --- SONG TABLE (CÓ THÊM NÚT SỬA/XÓA) --- */
        .song-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: var(--text-sub);
        }

        .song-table th {
            text-align: left;
            padding: 12px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            text-transform: uppercase;
        }

        .song-row {
            cursor: pointer;
            transition: 0.2s;
        }

        .song-row:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .song-row td {
            padding: 8px 24px;
        }

        .song-row.is-playing {
            color: var(--sp-light);
        }

        .song-row.is-playing b {
            color: var(--sp-light);
        }

        .song-actions-row {
            display: flex;
            gap: 15px;
            opacity: 0;
            transition: 0.2s;
        }

        .song-row:hover .song-actions-row {
            opacity: 1;
        }

        .action-icon {
            cursor: pointer;
        }

        .action-icon:hover {
            color: var(--sp-purple);
            transform: scale(1.2);
        }

        .action-icon.del:hover {
            color: #ff4d4d;
        }

        /* --- PLAYER BAR (GIỮ NGUYÊN ĐỂ KHÔNG LỆCH) --- */
        .player-bar {
            height: 90px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-top: 1px solid #282828;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 10000;
            box-sizing: border-box;
        }

        .p-left {
            width: 30%;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .p-center {
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .p-right {
            width: 30%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
        }

        .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
        }

        .bar-bg {
            background: #4d4d4d;
            height: 4px;
            flex: 1;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 0%;
        }

        .bar-bg:hover .bar-fill {
            background: var(--sp-purple);
        }

        .ctrl-btn {
            color: var(--text-sub);
            cursor: pointer;
            transition: 0.2s;
        }

        .ctrl-btn:hover,
        .ctrl-btn.active {
            color: #fff;
        }

        /* --- MODALS (CÓ INPUT FILE) --- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 100002;
            backdrop-filter: blur(5px);
        }

        .modal-box {
            background: #282828;
            padding: 30px;
            border-radius: 12px;
            width: 420px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-box h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-sub);
            text-transform: uppercase;
        }

        .modal-box input[type="text"] {
            background: #3e3e3e;
            border: 1px solid transparent;
            padding: 12px;
            color: white;
            border-radius: 4px;
            outline: none;
        }

        .modal-box input[type="file"] {
            background: #333;
            padding: 8px;
            border-radius: 4px;
            color: #bbb;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-confirm {
            background: var(--sp-purple);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }

        .btn-confirm:hover {
            background: var(--sp-light);
            transform: scale(1.02);
        }

        #contextMenu {
            position: fixed;
            background: #282828;
            min-width: 160px;
            border-radius: 4px;
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 100003;
            padding: 4px;
        }

        .menu-item {
            padding: 12px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 2px;
        }

        .menu-item:hover {
            background: #3e3e3e;
        }

        .menu-item.danger {
            color: #ff4d4d;
        }
    </style>
</head>

<body>

    <div id="toast-container"></div>

    <div id="contextMenu">
        <div class="menu-item" id="menuEdit"><i class="fas fa-edit"></i> Chỉnh sửa</div>
        <div class="menu-item danger" id="menuDelete"><i class="fas fa-trash"></i> Xóa</div>
    </div>

    <div class="wrapper">
        <div class="sidebar">
            <div class="side-box">
                <i class="fas fa-home side-icon active" onclick="showPage('home')"></i>
                <i class="fas fa-search side-icon"></i>
            </div>
            <div class="side-box" style="flex: 1;">
                <i class="fas fa-layer-group side-icon"></i>
                <i class="fas fa-plus side-icon" onclick="openCreateFolder()" title="Tạo Playlist Mới"></i>
            </div>
        </div>

        <div class="main-content" id="mainScroll">
            <div class="top-bar">
                <div class="profile-zone" onclick="openProfileModal()">
                    <img id="userImg" class="profile-img" src="https://via.placeholder.com/32">
                    <span id="userName" class="profile-name">Natsumi</span>
                </div>
            </div>

            <div id="homePage">
                <h2 style="padding: 20px 24px 0; font-size: 32px;">Chào buổi tối</h2>
                <div class="home-grid" id="folderGrid"></div>
            </div>

            <div id="folderPage" style="display: none;">
                <div id="headerGradient"
                    style="padding: 60px 24px 24px; display: flex; align-items: flex-end; gap: 24px;">
                    <img id="fImg"
                        style="width:232px; height:232px; border-radius:4px; object-fit:cover; box-shadow: 0 8px 40px rgba(0,0,0,0.5);">
                    <div>
                        <span style="font-size: 12px; font-weight: bold;">DANH SÁCH PHÁT</span>
                        <h1 id="fTitle" style="font-size: 72px; margin: 8px 0; letter-spacing: -2px; font-weight: 900;">
                        </h1>
                        <p id="fInfo" style="font-size: 14px; color: #fff;"></p>
                    </div>
                </div>

                <div style="padding: 24px; display: flex; align-items: center; gap: 24px;">
                    <button onclick="togglePlay()"
                        style="background:var(--sp-purple); border:none; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size: 24px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                        <i class="fas fa-play" id="bigPlayIcon"></i>
                    </button>
                    <button onclick="openCreateSong()"
                        style="background:transparent; border:1px solid var(--text-sub); color:white; padding: 10px 24px; border-radius:20px; font-weight:bold; cursor:pointer; letter-spacing: 1px;">THÊM
                        BÀI HÁT</button>
                    <button onclick="showPage('home')"
                        style="margin-left:auto; background:transparent; border:none; color:var(--text-sub); cursor:pointer; font-weight: bold;">QUAY
                        LẠI</button>
                </div>

                <table class="song-table">
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th>TIÊU ĐỀ</th>
                            <th>NGHỆ SĨ</th>
                            <th width="100">THAO TÁC</th>
                        </tr>
                    </thead>
                    <tbody id="songBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="player-bar">
        <div class="p-left">
            <img id="pImg" src="https://via.placeholder.com/56"
                style="width: 56px; height: 56px; border-radius: 4px; object-fit: cover;">
            <div style="overflow: hidden;">
                <b id="pTitle" style="font-size: 14px; display: block; white-space: nowrap;">Chưa chọn bài</b>
                <span id="pArtist" style="font-size: 11px; color: var(--text-sub);">Nghệ sĩ</span>
            </div>
        </div>
        <div class="p-center">
            <div style="display: flex; align-items: center; gap: 25px;">
                <i class="fas fa-shuffle ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()"></i>
                <i class="fas fa-step-backward ctrl-btn" onclick="prevSong()" style="font-size: 20px;"></i>
                <button onclick="togglePlay()"
                    style="background:#fff; border:none; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                    <i class="fas fa-play" id="pIcon" style="color:#000; font-size: 14px;"></i>
                </button>
                <i class="fas fa-step-forward ctrl-btn" onclick="nextSong()" style="font-size: 20px;"></i>
                <i class="fas fa-repeat ctrl-btn" id="repeatBtn" onclick="toggleRepeat()"></i>
            </div>
            <div class="progress-container">
                <span id="timeCurrent">0:00</span>
                <div class="bar-bg" onclick="seek(event)">
                    <div class="bar-fill" id="pFill"></div>
                </div>
                <span id="timeTotal">0:00</span>
            </div>
        </div>
        <div class="p-right">
            <i class="fas fa-volume-up ctrl-btn"></i>
            <div class="bar-bg" style="max-width: 100px;" onclick="changeVolume(event)">
                <div class="bar-fill" id="vFill" style="width: 80%;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-box">
            <h3 id="folderModalTitle">Tạo danh sách mới</h3>
            <div class="input-group">
                <label>Tên Playlist</label>
                <input type="text" id="fName" placeholder="Tên danh sách của bạn">
            </div>
            <div class="input-group">
                <label>Màu chủ đạo</label>
                <input type="color" id="fColor" value="#a855f7" style="height:45px; padding:2px; width: 100%;">
            </div>
            <div class="input-group">
                <label>Ảnh bìa (Chọn file)</label>
                <input type="file" id="fFile" accept="image/*">
            </div>
            <div class="input-group">
                <label>Hoặc dán Link ảnh</label>
                <input type="text" id="fImgLink" placeholder="https://example.com/image.jpg">
            </div>
            <button class="btn-confirm" onclick="handleFolderAction()">HOÀN TẤT</button>
            <button onclick="closeModal()"
                style="background:none; border:none; color:#ccc; cursor:pointer; margin-top:10px;">Hủy bỏ</button>
        </div>
    </div>

    <div class="modal" id="songModal">
        <div class="modal-box">
            <h3 id="songModalTitle">Thêm bài hát</h3>
            <div class="input-group">
                <label>Tiêu đề</label>
                <input type="text" id="sTitle" placeholder="Tên bài hát">
            </div>
            <div class="input-group">
                <label>Nghệ sĩ</label>
                <input type="text" id="sArtist" placeholder="Tên ca sĩ/nhóm nhạc">
            </div>
            <div class="input-group">
                <label>File Nhạc (MP3)</label>
                <input type="file" id="sAudioFile" accept="audio/*">
            </div>
            <div class="input-group">
                <label>Hoặc Link Nhạc</label>
                <input type="text" id="sAudioLink" placeholder="https://server.com/music.mp3">
            </div>
            <div class="input-group">
                <label>Ảnh Bài Hát (File)</label>
                <input type="file" id="sImgFile" accept="image/*">
            </div>
            <div class="input-group">
                <label>Hoặc Link Ảnh</label>
                <input type="text" id="sImgLink" placeholder="https://image-url.com">
            </div>
            <button class="btn-confirm" onclick="handleSongAction()">LƯU BÀI HÁT</button>
            <button onclick="closeModal()"
                style="background:none; border:none; color:#ccc; cursor:pointer; margin-top:10px;">Hủy bỏ</button>
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-box">
            <h3>Hồ sơ người dùng</h3>
            <div style="text-align:center; margin-bottom:15px;">
                <img id="previewAvatar" src=""
                    style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid var(--sp-purple);">
            </div>
            <div class="input-group">
                <label>Tên hiển thị</label>
                <input type="text" id="pfName">
            </div>
            <div class="input-group">
                <label>Ảnh đại diện (File)</label>
                <input type="file" id="pfFile" accept="image/*">
            </div>
            <button class="btn-confirm" onclick="saveProfile()">CẬP NHẬT</button>
            <button onclick="closeModal()"
                style="background:none; border:none; color:#ccc; cursor:pointer; margin-top:10px;">Đóng</button>
        </div>
    </div>

    <audio id="audio"></audio>

    <script>
        let db = JSON.parse(localStorage.getItem('sp_db')) || [{
            name: "YÊU THÍCH",
            img: "https://t.scdn.co/images/3099b3803817445a9147ef5035ba622a.png",
            color: "#5038a0",
            songs: []
        }];
        let user = JSON.parse(localStorage.getItem('sp_user')) || { name: "Natsumi", img: "https://via.placeholder.com/150" };

        let curFolderIdx = -1, curSongIdx = -1;
        let editFolderTarget = -1, editSongTarget = -1;
        let isShuffle = false, isRepeat = false;
        const audio = document.getElementById('audio');

        window.onload = () => { renderHome(); updateProfileUI(); };

        function save() {
            localStorage.setItem('sp_db', JSON.stringify(db));
            localStorage.setItem('sp_user', JSON.stringify(user));
        }

        /* --- HỆ THỐNG TOAST --- */
        function notify(msg) {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        /* --- XỬ LÝ FILE --- */
        function readFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        /* --- CONTEXT MENU SYSTEM (GỐC) --- */
        const ctxMenu = document.getElementById('contextMenu');
        function showContextMenu(e, type, index) {
            e.preventDefault();
            e.stopPropagation();
            ctxMenu.style.display = 'block';
            ctxMenu.style.top = `${e.clientY}px`;
            ctxMenu.style.left = `${e.clientX}px`;

            document.getElementById('menuEdit').onclick = () => {
                type === 'folder' ? openEditFolder(index) : openEditSong(index);
                hideContextMenu();
            };
            document.getElementById('menuDelete').onclick = () => {
                if (confirm("Xác nhận xóa?")) {
                    type === 'folder' ? deleteFolderDirect(index) : deleteSongDirect(index);
                }
                hideContextMenu();
            };
        }
        function hideContextMenu() { ctxMenu.style.display = 'none'; }
        document.addEventListener('click', hideContextMenu);

        /* --- FOLDER ACTIONS --- */
        function openCreateFolder() {
            editFolderTarget = -1;
            document.getElementById('folderModalTitle').innerText = "Tạo danh sách mới";
            document.getElementById('fName').value = "";
            document.getElementById('fImgLink').value = "";
            document.getElementById('fFile').value = "";
            document.getElementById('fColor').value = "#a855f7";
            openModal('folderModal');
        }

        function openEditFolder(i) {
            editFolderTarget = i;
            document.getElementById('folderModalTitle').innerText = "Chỉnh sửa danh sách";
            document.getElementById('fName').value = db[i].name;
            document.getElementById('fColor').value = db[i].color;
            document.getElementById('fImgLink').value = db[i].img.startsWith('data:') ? '' : db[i].img;
            openModal('folderModal');
        }

        async function handleFolderAction() {
            const name = document.getElementById('fName').value;
            const linkImg = document.getElementById('fImgLink').value;
            const color = document.getElementById('fColor').value;
            const file = document.getElementById('fFile').files[0];

            let img = linkImg || "https://via.placeholder.com/300";
            if (file) img = await readFile(file);
            else if (editFolderTarget > -1 && !linkImg) img = db[editFolderTarget].img; // Giữ ảnh cũ

            if (!name) return notify("Cần có tên playlist!");

            if (editFolderTarget === -1) {
                db.push({ name: name.toUpperCase(), img, color, songs: [] });
                notify("Đã tạo Playlist mới");
            } else {
                db[editFolderTarget].name = name.toUpperCase();
                db[editFolderTarget].img = img;
                db[editFolderTarget].color = color;
                notify("Đã cập nhật Playlist");
                if (curFolderIdx === editFolderTarget) openFolder(curFolderIdx);
            }
            save(); renderHome(); closeModal();
        }

        function deleteFolderDirect(i) {
            if (confirm("Xóa playlist này?")) {
                db.splice(i, 1);
                save(); renderHome();
                if (curFolderIdx === i) showPage('home');
                notify("Đã xóa Playlist");
            }
        }

        /* --- SONG ACTIONS --- */
        function openCreateSong() {
            editSongTarget = -1;
            document.getElementById('songModalTitle').innerText = "Thêm bài hát mới";
            document.getElementById('sTitle').value = "";
            document.getElementById('sArtist').value = "";
            document.getElementById('sAudioLink').value = "";
            document.getElementById('sAudioFile').value = "";
            document.getElementById('sImgLink').value = "";
            document.getElementById('sImgFile').value = "";
            openModal('songModal');
        }

        function openEditSong(i) {
            editSongTarget = i;
            const s = db[curFolderIdx].songs[i];
            document.getElementById('sTitle').value = s.title;
            document.getElementById('sArtist').value = s.artist;
            document.getElementById('sAudioLink').value = s.link.startsWith('data:') ? '' : s.link;
            document.getElementById('sImgLink').value = s.img.startsWith('data:') ? '' : s.img;
            openModal('songModal');
        }

        async function handleSongAction() {
            const title = document.getElementById('sTitle').value;
            const artist = document.getElementById('sArtist').value || "Nghệ sĩ";
            const linkAudio = document.getElementById('sAudioLink').value;
            const fileAudio = document.getElementById('sAudioFile').files[0];
            const linkImg = document.getElementById('sImgLink').value;
            const fileImg = document.getElementById('sImgFile').files[0];

            if (!title) return notify("Nhập tên bài hát!");

            let audioData = linkAudio;
            if (fileAudio) audioData = await readFile(fileAudio);
            else if (editSongTarget > -1 && !linkAudio) audioData = db[curFolderIdx].songs[editSongTarget].link;

            let imgData = linkImg || "https://via.placeholder.com/50";
            if (fileImg) imgData = await readFile(fileImg);
            else if (editSongTarget > -1 && !linkImg) imgData = db[curFolderIdx].songs[editSongTarget].img;

            if (!audioData) return notify("Cần có file nhạc hoặc Link nhạc!");

            const songObj = { title, artist, link: audioData, img: imgData };

            if (editSongTarget === -1) {
                db[curFolderIdx].songs.push(songObj);
                notify("Đã thêm bài hát");
            } else {
                db[curFolderIdx].songs[editSongTarget] = songObj;
                notify("Đã cập nhật bài hát");
            }
            save(); renderSongs(); closeModal();
        }

        function deleteSongDirect(i) {
            if (confirm("Xóa bài hát này?")) {
                db[curFolderIdx].songs.splice(i, 1);
                save(); renderSongs();
                notify("Đã xóa bài hát");
            }
        }

        /* --- CORE UI --- */
        function renderHome() {
            const grid = document.getElementById('folderGrid');
            grid.innerHTML = '';
            db.forEach((f, i) => {
                grid.innerHTML += `
                    <div class="card" onclick="openFolder(${i})" oncontextmenu="showContextMenu(event, 'folder', ${i})">
                        <div class="card-actions">
                            <button class="btn-mini" onclick="event.stopPropagation(); openEditFolder(${i})"><i class="fas fa-pen"></i></button>
                            <button class="btn-mini del" onclick="event.stopPropagation(); deleteFolderDirect(${i})"><i class="fas fa-trash"></i></button>
                        </div>
                        <img src="${f.img}">
                        <b style="display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${f.name}</b>
                        <p style="font-size:12px; color:var(--text-sub); margin:8px 0 0;">Playlist • ${f.songs.length} bài</p>
                    </div>`;
            });
        }

        function openFolder(i) {
            curFolderIdx = i;
            const f = db[i];
            document.getElementById('fTitle').innerText = f.name;
            document.getElementById('fImg').src = f.img;
            document.getElementById('fInfo').innerText = `Hệ thống • ${f.songs.length} bài hát`;
            document.getElementById('headerGradient').style.background = `linear-gradient(${f.color}, var(--bg-surface))`;
            renderSongs();
            showPage('folder');
        }

        function renderSongs() {
            const body = document.getElementById('songBody');
            body.innerHTML = '';
            db[curFolderIdx].songs.forEach((s, i) => {
                const activeClass = (curSongIdx === i) ? 'is-playing' : '';
                body.innerHTML += `
                    <tr class="song-row ${activeClass}" onclick="playSong(${i})" oncontextmenu="showContextMenu(event, 'song', ${i})">
                        <td width="30">${i + 1}</td>
                        <td>
                            <div style="display:flex; align-items:center; gap:12px;">
                                <img src="${s.img}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;">
                                <div><b class="song-title-text">${s.title}</b><br><small>${s.artist}</small></div>
                            </div>
                        </td>
                        <td>${s.artist}</td>
                        <td style="text-align:right">
                            <div class="card-actions" style="position:static; opacity:1">
                                <button class="btn-mini" onclick="event.stopPropagation(); openEditSong(${i})"><i class="fas fa-pen"></i></button>
                                <button class="btn-mini del" onclick="event.stopPropagation(); deleteSongDirect(${i})"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        /* --- PROFILE --- */
        function openProfileModal() {
            document.getElementById('pfName').value = user.name;
            document.getElementById('previewAvatar').src = user.img;
            openModal('profileModal');
        }

        async function saveProfile() {
            user.name = document.getElementById('pfName').value || user.name;
            const file = document.getElementById('pfFile').files[0];
            if (file) user.img = await readFile(file);
            save(); updateProfileUI(); closeModal(); notify("Hồ sơ đã cập nhật");
        }

        /* --- AUDIO ENGINE (GIỮ NGUYÊN) --- */
        function playSong(i) {
            curSongIdx = i;
            const s = db[curFolderIdx].songs[i];
            audio.src = s.link;
            audio.play();
            document.getElementById('pTitle').innerText = s.title;
            document.getElementById('pArtist').innerText = s.artist;
            document.getElementById('pImg').src = s.img;
            document.getElementById('pIcon').className = "fas fa-pause";
            document.getElementById('bigPlayIcon').className = "fas fa-pause";
            renderSongs();
        }

        function togglePlay() {
            if (!audio.src) return;
            audio.paused ? audio.play() : audio.pause();
            const icon = audio.paused ? "fas fa-play" : "fas fa-pause";
            document.getElementById('pIcon').className = icon;
            document.getElementById('bigPlayIcon').className = icon;
        }

        function nextSong() {
            if (curSongIdx === -1) return;
            let next = isShuffle ? Math.floor(Math.random() * db[curFolderIdx].songs.length) : curSongIdx + 1;
            if (next >= db[curFolderIdx].songs.length) next = 0;
            playSong(next);
        }

        function prevSong() {
            if (curSongIdx <= 0) return;
            playSong(curSongIdx - 1);
        }

        audio.ontimeupdate = () => {
            const per = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('pFill').style.width = per + '%';
            document.getElementById('timeCurrent').innerText = formatTime(audio.currentTime);
            if (audio.duration) document.getElementById('timeTotal').innerText = formatTime(audio.duration);
        };
        audio.onended = () => isRepeat ? audio.play() : nextSong();

        /* --- UTILS --- */
        function formatTime(s) {
            let m = Math.floor(s / 60), sec = Math.floor(s % 60);
            return m + ":" + (sec < 10 ? "0" + sec : sec);
        }

        function showPage(p) {
            document.getElementById('homePage').style.display = p === 'home' ? 'block' : 'none';
            document.getElementById('folderPage').style.display = p === 'folder' ? 'block' : 'none';
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

        function updateProfileUI() {
            document.getElementById('userName').innerText = user.name;
            document.getElementById('userImg').src = user.img;
        }

        function toggleShuffle() { isShuffle = !isShuffle; document.getElementById('shuffleBtn').classList.toggle('active', isShuffle); notify(isShuffle ? "Bật trộn bài" : "Tắt trộn bài"); }
        function toggleRepeat() { isRepeat = !isRepeat; document.getElementById('repeatBtn').classList.toggle('active', isRepeat); notify(isRepeat ? "Bật lặp lại" : "Tắt lặp lại"); }
        function seek(e) { const rect = e.currentTarget.getBoundingClientRect(); audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration; }
        function changeVolume(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            let v = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audio.volume = v;
            document.getElementById('vFill').style.width = (v * 100) + '%';
        }

        window.onclick = e => { if (e.target.className === 'modal') closeModal(); };
    </script>
</body>

</html>
