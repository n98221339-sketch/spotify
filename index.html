<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Premium - Fixed Version</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/w9B1mZG/Spotify-Icon-Logo-wine.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-base: #000000;
            --bg-surface: #121212;
            --bg-card: #181818;
            --sp-green: #1ed760;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --header-color: #535353;
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-main);
            font-family: 'Circular Sp', sans-serif, "Helvetica Neue", Helvetica, Arial;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 8px;
            gap: 8px;
        }

        .sidebar {
            width: 72px;
            background: var(--bg-base);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .side-box {
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .side-icon {
            font-size: 24px;
            color: var(--text-sub);
            cursor: pointer;
            transition: 0.2s;
        }

        .side-icon:hover,
        .side-icon.active {
            color: white;
        }

        .main-content {
            flex: 1;
            background: var(--bg-surface);
            border-radius: 8px;
            overflow-y: auto;
            position: relative;
            scroll-behavior: smooth;
        }

        .top-bar {
            position: sticky;
            top: 0;
            height: 64px;
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            gap: 20px;
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn-login {
            background: none;
            border: none;
            color: var(--text-sub);
            font-weight: bold;
            cursor: pointer;
        }

        .btn-signup {
            background: white;
            color: black;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
        }

        .profile-zone {
            display: none;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px 4px 4px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }

        .profile-zone:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .profile-img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background: #282828;
        }

        .header-section {
            padding: 80px 24px 24px 24px;
            background: linear-gradient(to bottom, var(--header-color) 0%, var(--bg-surface) 100%);
            display: flex;
            align-items: flex-end;
            gap: 24px;
            margin-top: -64px;
        }

        .header-section img {
            width: 232px;
            height: 232px;
            box-shadow: 0 4px 60px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            object-fit: cover;
        }

        .header-text h1 {
            font-size: 72px;
            margin: 8px 0;
            letter-spacing: -3px;
            font-weight: 900;
        }

        .play-btn-main {
            width: 56px;
            height: 56px;
            background: var(--sp-green);
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .song-table {
            width: 100%;
            border-collapse: collapse;
            padding: 0 24px;
            margin-bottom: 50px;
        }

        .song-table th {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-sub);
            text-align: left;
            padding: 10px;
            font-size: 13px;
        }

        .song-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .song-row td {
            padding: 12px 10px;
            font-size: 14px;
            color: var(--text-sub);
            cursor: pointer;
        }

        .playing-now b {
            color: var(--sp-green) !important;
        }

        .song-opt-btn {
            color: var(--text-sub);
            opacity: 0;
            transition: 0.2s;
            padding: 8px;
            cursor: pointer;
        }

        .song-row:hover .song-opt-btn {
            opacity: 1;
        }

        .player-bar {
            height: 90px;
            background: black;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-top: 1px solid #282828;
            position: relative;
            z-index: 1000;
        }

        .p-left {
            width: 30%;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .p-center {
            flex: 1;
            max-width: 722px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .p-right {
            width: 30%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
        }

        .ctrl-btn {
            color: var(--text-sub);
            cursor: pointer;
            font-size: 16px;
        }

        .ctrl-active {
            color: var(--sp-green) !important;
        }

        .bar-bg {
            height: 4px;
            background: #4f4f4f;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            width: 100%;
        }

        .bar-fill {
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 0%;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-box {
            background: #282828;
            padding: 25px;
            border-radius: 12px;
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-box input,
        .modal-box select {
            background: #3e3e3e;
            border: none;
            padding: 12px;
            border-radius: 4px;
            color: white;
            outline: none;
        }

        .btn-add {
            background: var(--sp-green);
            color: black;
            font-weight: bold;
            padding: 12px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        .preview-img-box {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            border: 2px dashed #555;
            align-self: center;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
            background: #181818;
            position: relative;
        }

        .preview-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-label {
            position: absolute;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            width: 100%;
            text-align: center;
            font-size: 10px;
            padding: 5px 0;
            cursor: pointer;
        }

        .home-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            padding: 24px;
        }

        .card {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: 0.3s;
        }

        .card:hover {
            background: #282828;
        }

        .card img {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 6px;
            margin-bottom: 12px;
            object-fit: cover;
        }

        .card-menu-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 35px;
            height: 35px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .card:hover .card-menu-btn {
            display: flex;
        }

        .context-menu {
            position: fixed;
            background: #282828;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 10000;
            min-width: 160px;
        }

        .context-menu-item {
            padding: 12px;
            font-size: 14px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: #3e3e3e;
        }
    </style>
</head>

<body>

    <div class="wrapper">
        <div class="sidebar">
            <div class="side-box">
                <i class="fas fa-home side-icon active" onclick="showPage('home')"></i>
                <i class="fas fa-search side-icon"></i>
            </div>
            <div class="side-box" style="flex: 1;">
                <i class="fas fa-layer-group side-icon"></i>
                <i class="fas fa-plus side-icon" onclick="openCreateFolderModal()" title="Thêm danh sách"></i>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <div class="top-bar">
                <div class="auth-buttons" id="authBox">
                    <button class="btn-login" onclick="openModal('authModal')">Đăng ký</button>
                    <button class="btn-signup" onclick="openModal('authModal')">Đăng nhập</button>
                </div>
                <div class="profile-zone" id="profileBox" onclick="openProfileEdit()">
                    <img id="userImg" class="profile-img" src="">
                    <span id="userName" class="profile-name"></span>
                </div>
            </div>

            <div id="homePage">
                <h2 style="padding: 20px 24px 0;">Chào buổi tối</h2>
                <div class="home-grid" id="folderGrid"></div>
            </div>

            <div id="folderPage" style="display: none;">
                <div class="header-section" id="headerGradient">
                    <img id="fImg" src="">
                    <div class="header-text">
                        <span style="font-size: 13px; font-weight: bold;">DANH SÁCH PHÁT</span>
                        <h1 id="fTitle"></h1>
                        <div style="font-size: 14px;"><b id="fOwnerDisplay">Admin</b> • <span id="fCount">0</span> bài hát</div>
                    </div>
                </div>

                <div style="padding: 24px; display: flex; align-items: center; gap: 25px;">
                    <button class="play-btn-main" onclick="togglePlay()"><i class="fas fa-play" id="bigPlayIcon"></i></button>
                    <i class="fas fa-plus-circle ctrl-btn" title="Thêm nhạc" onclick="openSongModal()" style="font-size: 24px;"></i>
                    <i class="fas fa-arrow-left ctrl-btn" onclick="showPage('home')" style="margin-left: auto;"> Quay lại</i>
                </div>

                <table class="song-table">
                    <thead>
                        <tr>
                            <th width="40">#</th>
                            <th>TIÊU ĐỀ</th>
                            <th>NGHỆ SĨ</th>
                            <th><i class="far fa-clock"></i></th>
                            <th width="40"></th>
                        </tr>
                    </thead>
                    <tbody id="songBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="player-bar">
        <div class="p-left">
            <img id="pImg" src="https://via.placeholder.com/56" style="width: 56px; height: 56px; border-radius: 4px; object-fit: cover;">
            <div style="overflow: hidden;">
                <b id="pTitle" style="font-size: 14px; white-space: nowrap; color: white;">Chưa chọn bài</b>
                <span id="pArtist" style="font-size: 11px; color: var(--text-sub); display: block;">Nghệ sĩ</span>
            </div>
        </div>
        <div class="p-center">
            <div style="display: flex; align-items: center; gap: 20px;">
                <i class="fas fa-shuffle ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()"></i>
                <i class="fas fa-step-backward ctrl-btn" onclick="prevSong()"></i>
                <button onclick="togglePlay()" style="background:white; border:none; width:35px; height:35px; border-radius:50%; cursor:pointer; display: flex; align-items:center; justify-content:center;">
                    <i class="fas fa-play" id="pIcon" style="color:black; font-size: 14px;"></i>
                </button>
                <i class="fas fa-step-forward ctrl-btn" onclick="nextSong()"></i>
                <i class="fas fa-repeat ctrl-btn" id="repeatBtn" onclick="toggleRepeat()"></i>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; width: 100%; font-size: 11px;">
                <span id="timeCurrent">0:00</span>
                <div class="bar-bg" onclick="seek(event)">
                    <div class="bar-fill" id="pFill"></div>
                </div>
                <span id="timeTotal">0:00</span>
            </div>
        </div>
        <div class="p-right">
            <i class="fas fa-volume-up" style="font-size: 14px; color: var(--text-sub);"></i>
            <div class="bar-bg" style="width: 100px;" onclick="changeVolume(event)">
                <div class="bar-fill" id="vFill" style="width: 80%;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="authModal">
        <div class="modal-box">
            <h3 id="authModalTitle">Chào mừng bạn</h3>
            <input type="text" id="authName" placeholder="Tên hiển thị...">
            <input type="text" id="authLinkInp" placeholder="Link ảnh đại diện (URL)..." oninput="document.getElementById('authPreview').src=this.value">
            <div class="preview-img-box" style="border-radius: 50%;">
                <img id="authPreview" src="https://i.pravatar.cc/150">
                <label class="file-label" for="authFile">Chọn tệp</label>
                <input type="file" id="authFile" hidden onchange="handleFileSelect(this, 'authPreview')">
            </div>
            <button class="btn-add" id="authSubmitBtn" onclick="fakeLogin()">BẮT ĐẦU NGAY</button>
        </div>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-box">
            <h3 id="folderModalTitle">Tạo danh sách mới</h3>
            <input type="text" id="fName" placeholder="Tên danh sách...">
            <input type="text" id="fLinkInp" placeholder="Dán link ảnh bìa (URL)..." oninput="document.getElementById('fPreview').src=this.value">
            <div class="preview-img-box">
                <img id="fPreview" src="https://via.placeholder.com/300">
                <label class="file-label" for="fFile">Tải ảnh lên</label>
                <input type="file" id="fFile" hidden onchange="handleFileSelect(this, 'fPreview')">
            </div>
            <input type="color" id="fColor" value="#1ed760" style="height: 40px; width: 100%;">
            <button class="btn-add" id="folderSubmitBtn" onclick="createFolder()">HOÀN TẤT</button>
        </div>
    </div>

    <div class="modal" id="songModal">
        <div class="modal-box">
            <h3 id="songModalTitle">Thêm bài hát</h3>
            <select id="sTarget"></select>
            <input type="text" id="sTitle" placeholder="Tên bài hát">
            <input type="text" id="sArtist" placeholder="Nghệ sĩ">
            <input type="text" id="sImgUrl" placeholder="Link ảnh bài hát (URL)..." oninput="document.getElementById('sImgPreview').src=this.value">
            <div class="preview-img-box" style="width: 80px; height: 80px;">
                <img id="sImgPreview" src="https://via.placeholder.com/150">
                <label class="file-label" for="sFile">Tải lên</label>
                <input type="file" id="sFile" hidden onchange="handleFileSelect(this, 'sImgPreview')">
            </div>
            <input type="text" id="sLink" placeholder="Link nhạc (.mp3)">
            <button class="btn-add" id="songSubmitBtn" onclick="addNewSong()">HOÀN TẤT</button>
        </div>
    </div>

    <div id="folderContextMenu" class="context-menu">
        <div class="context-menu-item" onclick="editFolder()"><i class="fas fa-edit"></i> Chỉnh sửa</div>
        <div class="context-menu-item" onclick="deleteFolder()" style="color:#ff4d4d;"><i class="fas fa-trash"></i> Xóa thư mục</div>
    </div>

    <div id="songContextMenu" class="context-menu">
        <div class="context-menu-item" onclick="editSong()"><i class="fas fa-edit"></i> Chỉnh sửa bài</div>
        <div class="context-menu-item" onclick="deleteCurrentSong()" style="color:#ff4d4d;"><i class="fas fa-trash"></i> Xóa bài hát</div>
    </div>

    <audio id="audio"></audio>

    <script>
        let db = JSON.parse(localStorage.getItem('sp_db')) || [{
            name: "Nhạc Chill Mỗi Ngày",
            img: "https://images.unsplash.com/photo-1459749411177-042180ce673c?w=500",
            color: "#1e3264",
            songs: [{
                title: "Bản nhạc mẫu",
                artist: "SoundHelix",
                link: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
                img: "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=100"
            }]
        }];

        let user = JSON.parse(localStorage.getItem('sp_user')) || null;
        let curFolder = -1, curSong = -1, isShuffle = false, isRepeat = false;
        let playedFromFolder = -1, folderTarget = -1, songTargetIdx = -1;
        let editingMode = false;

        const audio = document.getElementById('audio');

        window.onload = () => { renderHome(); checkAuth(); };

        function save() {
            localStorage.setItem('sp_db', JSON.stringify(db));
            localStorage.setItem('sp_user', JSON.stringify(user));
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }

        window.onclick = (e) => {
            if (e.target.className === 'modal') e.target.style.display = 'none';
            document.getElementById('folderContextMenu').style.display = 'none';
            document.getElementById('songContextMenu').style.display = 'none';
        }

        function handleFileSelect(input, previewId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById(previewId).src = e.target.result; };
                reader.readAsDataURL(file);
            }
        }

        // --- PROFILE LOGIC ---
        function checkAuth() {
            const ab = document.getElementById('authBox'), pb = document.getElementById('profileBox');
            if (user) {
                ab.style.display = 'none'; pb.style.display = 'flex';
                document.getElementById('userName').innerText = user.name;
                document.getElementById('userImg').src = user.img;
            } else {
                ab.style.display = 'flex'; pb.style.display = 'none';
            }
        }

        function openProfileEdit() {
            document.getElementById('authModalTitle').innerText = "Chỉnh sửa hồ sơ";
            document.getElementById('authName').value = user.name;
            document.getElementById('authPreview').src = user.img;
            document.getElementById('authSubmitBtn').innerText = "CẬP NHẬT";
            openModal('authModal');
        }

        function fakeLogin() {
            const name = document.getElementById('authName').value || "Người dùng";
            const img = document.getElementById('authPreview').src;
            user = { name: name, img: img };
            save(); checkAuth(); 
            document.getElementById('authModal').style.display = 'none';
        }

        // --- FOLDER LOGIC ---
        function openCreateFolderModal() {
            editingMode = false;
            document.getElementById('folderModalTitle').innerText = "Tạo danh sách mới";
            document.getElementById('fName').value = "";
            document.getElementById('fPreview').src = "https://via.placeholder.com/300";
            openModal('folderModal');
        }

        function createFolder() {
            const name = document.getElementById('fName').value;
            const img = document.getElementById('fPreview').src;
            const color = document.getElementById('fColor').value;
            if (name) {
                if (editingMode) {
                    db[folderTarget].name = name; db[folderTarget].img = img; db[folderTarget].color = color;
                } else {
                    db.push({ name, img, color, songs: [] });
                }
                save(); renderHome(); document.getElementById('folderModal').style.display = 'none';
            }
        }

        function renderHome() {
            const grid = document.getElementById('folderGrid'); grid.innerHTML = '';
            db.forEach((f, i) => {
                grid.innerHTML += `
                    <div class="card" onclick="openFolder(${i})">
                        <div class="card-menu-btn" onclick="showMenu(event, ${i})"><i class="fas fa-ellipsis-h"></i></div>
                        <img src="${f.img}">
                        <b>${f.name}</b>
                    </div>`;
            });
            showPage('home');
        }

        function showMenu(e, i) {
            e.stopPropagation(); folderTarget = i;
            const m = document.getElementById('folderContextMenu');
            m.style.display = 'block'; m.style.top = e.clientY + 'px'; m.style.left = e.clientX + 'px';
        }

        function deleteFolder() {
            if (confirm("Xóa danh sách này?")) { db.splice(folderTarget, 1); save(); renderHome(); }
        }

        function editFolder() {
            editingMode = true;
            const f = db[folderTarget];
            document.getElementById('folderModalTitle').innerText = "Chỉnh sửa danh sách";
            document.getElementById('fName').value = f.name;
            document.getElementById('fPreview').src = f.img;
            document.getElementById('fColor').value = f.color;
            openModal('folderModal');
        }

        function openFolder(i) {
            curFolder = i;
            document.getElementById('fTitle').innerText = db[i].name;
            document.getElementById('fImg').src = db[i].img;
            document.getElementById('headerGradient').style.setProperty('--header-color', db[i].color);
            renderSongs(); showPage('folder');
        }

        function showPage(p) {
            document.getElementById('homePage').style.display = p === 'home' ? 'block' : 'none';
            document.getElementById('folderPage').style.display = p === 'folder' ? 'block' : 'none';
        }

        // --- SONG LOGIC ---
        function openSongModal() {
            editingMode = false;
            document.getElementById('songModalTitle').innerText = "Thêm bài hát";
            const sel = document.getElementById('sTarget'); sel.innerHTML = '';
            db.forEach((f, i) => { sel.innerHTML += `<option value="${i}" ${i === curFolder ? 'selected' : ''}>${f.name}</option>`; });
            document.getElementById('sTitle').value = '';
            document.getElementById('sArtist').value = '';
            document.getElementById('sImgPreview').src = 'https://via.placeholder.com/150';
            document.getElementById('sLink').value = '';
            openModal('songModal');
        }

        function addNewSong() {
            const idx = document.getElementById('sTarget').value;
            const title = document.getElementById('sTitle').value;
            const artist = document.getElementById('sArtist').value || "Nghệ sĩ";
            const link = document.getElementById('sLink').value;
            const img = document.getElementById('sImgPreview').src;
            if (title && link) {
                if (editingMode) {
                    db[curFolder].songs[songTargetIdx] = { title, artist, link, img };
                } else {
                    db[idx].songs.push({ title, artist, link, img });
                }
                save(); renderSongs(); document.getElementById('songModal').style.display = 'none';
            }
        }

        function renderSongs() {
            const body = document.getElementById('songBody'); body.innerHTML = '';
            if (curFolder === -1) return;
            db[curFolder].songs.forEach((s, i) => {
                const isPlaying = (playedFromFolder === curFolder && curSong === i);
                body.innerHTML += `
                    <tr class="song-row ${isPlaying ? 'playing-now' : ''}" onclick="playSong(${i})">
                        <td>${isPlaying ? '<i class="fas fa-volume-up"></i>' : i + 1}</td>
                        <td><div style="display:flex;align-items:center;gap:10px;"><img src="${s.img}" style="width:40px;height:40px;border-radius:4px;"><b>${s.title}</b></div></td>
                        <td>${s.artist}</td>
                        <td>3:45</td>
                        <td onclick="showSongContext(event, ${i})"><i class="fas fa-ellipsis-v song-opt-btn"></i></td>
                    </tr>`;
            });
            document.getElementById('fCount').innerText = db[curFolder].songs.length;
        }

        function showSongContext(e, i) {
            e.stopPropagation(); songTargetIdx = i;
            const m = document.getElementById('songContextMenu');
            m.style.display = 'block'; m.style.top = e.clientY + 'px'; m.style.left = (e.clientX - 160) + 'px';
        }

        function editSong() {
            editingMode = true;
            const s = db[curFolder].songs[songTargetIdx];
            document.getElementById('songModalTitle').innerText = "Chỉnh sửa bài hát";
            document.getElementById('sTitle').value = s.title;
            document.getElementById('sArtist').value = s.artist;
            document.getElementById('sLink').value = s.link;
            document.getElementById('sImgPreview').src = s.img;
            openModal('songModal');
        }

        function deleteCurrentSong() {
            if (confirm("Xóa bài hát này?")) { db[curFolder].songs.splice(songTargetIdx, 1); save(); renderSongs(); }
        }

        // --- PLAYBACK ENGINE (FIXED) ---
        function playSong(i) {
            if (curFolder === -1 || !db[curFolder].songs[i]) return;
            curSong = i; playedFromFolder = curFolder;
            const s = db[playedFromFolder].songs[curSong];
            audio.src = s.link;
            audio.play().catch(e => console.log("Audio play failed", e));
            
            document.getElementById('pTitle').innerText = s.title;
            document.getElementById('pArtist').innerText = s.artist;
            document.getElementById('pImg').src = s.img;
            document.getElementById('pIcon').className = "fas fa-pause";
            document.getElementById('bigPlayIcon').className = "fas fa-pause";
            renderSongs();
        }

        function togglePlay() {
            if (!audio.src) {
                if (db[curFolder]?.songs.length > 0) playSong(0);
                return;
            }
            if (audio.paused) { 
                audio.play(); 
                document.getElementById('pIcon').className = "fas fa-pause"; 
                document.getElementById('bigPlayIcon').className = "fas fa-pause"; 
            } else { 
                audio.pause(); 
                document.getElementById('pIcon').className = "fas fa-play"; 
                document.getElementById('bigPlayIcon').className = "fas fa-play"; 
            }
        }

        function nextSong() {
            if (playedFromFolder === -1) return;
            let next = curSong + 1;
            // Nếu hết danh sách thì quay về bài đầu
            if (next >= db[playedFromFolder].songs.length) next = 0;
            playSong(next);
        }

        function prevSong() {
            if (playedFromFolder === -1) return;
            let prev = curSong - 1;
            if (prev < 0) prev = db[playedFromFolder].songs.length - 1;
            playSong(prev);
        }

        function toggleRepeat() { isRepeat = !isRepeat; document.getElementById('repeatBtn').classList.toggle('ctrl-active', isRepeat); }
        function toggleShuffle() { isShuffle = !isShuffle; document.getElementById('shuffleBtn').classList.toggle('ctrl-active', isShuffle); }

        audio.ontimeupdate = () => {
            const per = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('pFill').style.width = per + '%';
            document.getElementById('timeCurrent').innerText = formatTime(audio.currentTime);
            document.getElementById('timeTotal').innerText = formatTime(audio.duration || 0);
        };

        // FIXED: Xử lý khi kết thúc bài hát
        audio.onended = () => { 
            if (isRepeat) { 
                audio.currentTime = 0;
                audio.play(); 
            } else { 
                nextSong(); // Luôn tự động nhảy sang bài tiếp theo (bài 2, 3...)
            } 
        };

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function seek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const per = (e.clientX - rect.left) / rect.width;
            audio.currentTime = per * audio.duration;
        }

        function changeVolume(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const per = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audio.volume = per;
            document.getElementById('vFill').style.width = (per * 100) + '%';
        }
    </script>
</body>
</html>
